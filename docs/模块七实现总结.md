# 模块七：Budyko归因分析（budyko_attribution.py）实现总结

**作者**: Research Software Engineer  
**日期**: 2025-01-01  
**模块版本**: 1.0  
**测试状态**: ✅ 25/25 通过 (1.26s)

---

## 1. 模块概述

### 1.1 核心功能

`budyko_attribution.py` 实现基于Budyko框架的径流变化归因分析，量化三大驱动因子的贡献：
- **CCV** (Climate Change and Variability): 气候变化与变率
- **LUCC** (Land Use/Cover Change): 土地利用/覆盖变化  
- **WADR** (Water Abstraction, Diversion, Regulation): 人类取用水及调蓄

### 1.2 理论依据

基于 **main.tex** 的完整6步流程（Steps 1-6）：

```
Step 1: 全时段参数n率定        → 获取流域固有特征
Step 2: 计算弹性系数           → εP, εPET, εn
Step 3: 分时段参数n率定        → 量化LUCC影响
Step 4: 计算驱动因子绝对贡献   → ΔQn,CCV, ΔQn,LUCC (mm)
Step 5: 计算相对贡献率         → C_CCV, C_LUCC, C_WADR (%)
Step 6: 模型验证               → ΔQ̂n vs ΔQn 一致性检验
```

### 1.3 模块结构

```
budyko_attribution.py (~680 lines)
├── BudykoAttribution 类          # 核心归因分析
│   ├── __init__()                # 数据初始化
│   ├── set_periods()             # 时段划分
│   ├── validate_data_quality()   # 数据验证
│   └── run_attribution()         # 执行6步流程
│
├── batch_attribution()           # 批量处理多站点
└── summarize_attribution()       # 结果文本摘要
```

---

## 2. 核心API

### 2.1 BudykoAttribution 类

#### 初始化

```python
from src.budyko_model.budyko_attribution import BudykoAttribution

attribution = BudykoAttribution(station_data)
```

**输入数据要求**：
- `pandas.DataFrame` 包含列：`['year', 'P', 'PET', 'Qn', 'Qo']`
- `P`, `PET`, `Qn`, `Qo` 单位：mm/year
- 建议时间序列长度：≥20年

#### 时段划分

```python
attribution.set_periods(change_year=1986)
```

- 默认突变年份：1986（中国大规模水土保持工程起始）
- 可自定义：根据突变检测结果或专家知识设定

#### 执行归因

```python
results = attribution.run_attribution()
```

**返回结果**（dict）：

| 键名 | 类型 | 说明 |
|------|------|------|
| `n_full`, `n_pre`, `n_post` | float | 参数n（全时段、基准期、影响期） |
| `delta_P`, `delta_PET`, `delta_n` | float | 驱动因子变化量 |
| `delta_Qo`, `delta_Qn` | float | 观测/天然径流变化 (mm) |
| `delta_Qn_CCV`, `delta_Qn_LUCC` | float | 绝对贡献 (mm) |
| `C_CCV`, `C_LUCC`, `C_WADR` | float | 贡献率 (%) |
| `elasticity` | dict | 弹性系数 {eps_P, eps_PET, eps_n} |
| `validation` | dict | 验证指标 |

### 2.2 批量处理

```python
from src.budyko_model.budyko_attribution import batch_attribution

results_df = batch_attribution(
    multi_station_data,
    change_year=1986,
    station_id_col='station_id'
)
```

- 自动识别站点、并行处理
- 失败站点跳过并记录警告
- 返回汇总 DataFrame

---

## 3. 数学原理

### 3.1 归因分解公式

根据 main.tex equations (7)-(10)：

**绝对贡献**（mm）：
$$
\begin{aligned}
\Delta Q_{n,CCV} &= \varepsilon_P \frac{Q_n}{P} \Delta P + \varepsilon_{PET} \frac{Q_n}{PET} \Delta PET \\
\Delta Q_{n,LUCC} &= \varepsilon_n \frac{Q_n}{n} \Delta n
\end{aligned}
$$

**相对贡献率**（%）：
$$
\begin{aligned}
C_{CCV} &= \frac{\Delta Q_{n,CCV}}{\Delta Q_o} \times 100\% \\
C_{LUCC} &= \frac{\Delta Q_{n,LUCC}}{\Delta Q_o} \times 100\% \\
C_{WADR} &= \frac{\Delta Q_o - \Delta Q_n}{\Delta Q_o} \times 100\%
\end{aligned}
$$

### 3.2 物理约束

- **水量平衡**: $0 \leq Q_n < P$（否则率定失败）
- **弹性系数符号**: $\varepsilon_P > 0$, $\varepsilon_{PET} < 0$, $\varepsilon_n < 0$
- **贡献率之和**: $C_{CCV} + C_{LUCC} + C_{WADR} \approx 100\%$（允许±10%）

---

## 4. 测试验证

### 4.1 测试覆盖

**test_budyko_attribution.py** (~610行，25个测试)：

| 测试类 | 测试数 | 覆盖内容 |
|--------|--------|----------|
| TestInitialization | 3 | 数据初始化、列验证、排序 |
| TestPeriodSetting | 3 | 时段划分、自定义突变年 |
| TestDataValidation | 4 | 负值检测、水量平衡、跨流域调水 |
| TestCompleteAttribution | 4 | 完整流程、参数率定、弹性计算 |
| TestLoessPlateau | 1 | 黄土高原退耕还林案例 |
| TestEdgeCases | 3 | 异常处理、极小变化、水量平衡违背 |
| TestBatchAttribution | 2 | 批量处理、部分失败容错 |
| TestUtilityFunctions | 1 | 结果摘要生成 |
| TestPhysicalConsistency | 2 | 径流变化方向、放大效应 |
| TestNumericalStability | 2 | 极端干旱/湿润条件 |

### 4.2 测试结果

```bash
======================== 25 passed in 1.26s ========================
```

**关键验证**：
- ✅ 参数n范围合理（0.5 ~ 10）
- ✅ 弹性系数符号正确
- ✅ 贡献率之和 90-110%
- ✅ 黄土高原案例：LUCC主导（$|C_{LUCC}| > |C_{CCV}|$）
- ✅ 极端条件数值稳定

---

## 5. 使用示例

### 5.1 单站点归因

```python
import pandas as pd
from src.budyko_model.budyko_attribution import BudykoAttribution

# 加载数据
data = pd.read_csv('station_data.csv')

# 执行归因
attribution = BudykoAttribution(data)
attribution.set_periods(change_year=1986)
results = attribution.run_attribution()

# 查看结果
print(f"气候变化贡献: {results['C_CCV']:.1f}%")
print(f"土地利用变化: {results['C_LUCC']:.1f}%")
print(f"人类取用水: {results['C_WADR']:.1f}%")
```

### 5.2 黄土高原案例

```python
# 模拟退耕还林流域（1999年突变）
loess_data = pd.DataFrame({
    'year': range(1970, 2017),
    'P': [450]*29 + [430]*18,      # 降水略减
    'PET': [1200]*29 + [1250]*18,  # PET增加
    'Qn': [...],                   # 天然径流
    'Qo': [...]                    # 观测径流
})

attribution = BudykoAttribution(loess_data)
attribution.set_periods(change_year=1999)
results = attribution.run_attribution()

# 预期结果：C_LUCC 占主导（70-80%）
```

### 5.3 批量处理

```python
from src.budyko_model.budyko_attribution import batch_attribution

# 100个站点数据
all_stations = pd.read_csv('china_stations.csv')

# 批量归因
results = batch_attribution(all_stations, change_year=1986)

# 统计分析
print(results[['station_id', 'C_CCV', 'C_LUCC', 'C_WADR']].describe())

# 筛选LUCC主导站点
lucc_dominated = results[abs(results['C_LUCC']) > abs(results['C_CCV'])]
print(f"LUCC主导站点数: {len(lucc_dominated)}")
```

### 5.4 结果摘要

```python
from src.budyko_model.budyko_attribution import summarize_attribution

summary = summarize_attribution(results)
print(summary)
```

**输出示例**：
```
======================================================================
Budyko归因分析结果摘要
======================================================================

【参数n变化】
  全时段: n = 2.342
  基准期: n = 2.000
  影响期: n = 2.500
  变化量: Δn = +0.500

【径流变化】
  观测径流: 200.0 → 150.0 mm (Δ = -50.0 mm, -25.0%)

【归因结果 - 相对贡献率】
  气候变化 (C_CCV): 35.2%
  土地利用 (C_LUCC): 52.8%
  人类取用水 (C_WADR): 12.0%

【主导因素】
  土地利用变化是径流减少的主导因素 (52.8%)
======================================================================
```

---

## 6. 关键技术要点

### 6.1 时间尺度

- **Budyko假设**: 适用于多年平均稳态
- **实际操作**: 使用长序列（≥10年）均值进行参数率定
- **注意**: 不要对单年数据单独反算n，会引入噪声

### 6.2 参数率定策略

```python
# Step 1: 全时段率定（用于弹性系数）
n_full = calibrate_n(P_1960-2016, PET_1960-2016, Qn_1960-2016)

# Step 3: 分时段率定（量化Δn）
n_pre = calibrate_n(P_1960-1985, PET_1960-1985, Qn_1960-1985)
n_post = calibrate_n(P_1986-2016, PET_1986-2016, Qn_1986-2016)

delta_n = n_post - n_pre  # 反映LUCC影响
```

### 6.3 异常处理

| 场景 | 检测 | 处理 |
|------|------|------|
| 水量平衡违背 | $Q_n \geq P$ | 抛出 ValueError |
| 径流变化过小 | $\|\Delta Q_o\| < 1$ mm | 发出 Warning |
| 跨流域调水 | $Q_o > Q_n$ | 发出 Warning |
| 参数率定失败 | 无解 | 抛出 ValueError |

### 6.4 贡献率解读

**符号约定**：
- $\Delta Q < 0$：径流减少
- $C > 0$：正贡献（加剧减少）
- $C < 0$：负贡献（缓解减少）

**案例**：
- 降水减少、PET增加 → $C_{CCV} > 0$（加剧减少）
- 退耕还林（n增大）→ $C_{LUCC} > 0$（加剧减少）
- 跨流域调水 → $C_{WADR} > 0$（加剧减少）

---

## 7. 与已有模块的集成

### 7.1 依赖关系

```
budyko_attribution.py
├── core_equations.py          # BudykoModel.calibrate_parameter_n()
└── elasticity_solver.py       # calculate_elasticity_P/PET/n()
```

### 7.2 工作流整合

```python
# 完整归因流水线
from src.budyko_model.budyko_attribution import BudykoAttribution

# 1. 数据预处理（未来模块）
# data = preprocess_grdc_data(station_id)

# 2. 归因分析（本模块）
attribution = BudykoAttribution(data)
attribution.set_periods(change_year=1986)
results = attribution.run_attribution()

# 3. 可视化（未来扩展）
# plot_attribution_results(results)
```

---

## 8. 局限性与未来扩展

### 8.1 当前局限

1. **单突变点**: 仅支持一个change_year，不支持多突变点
2. **年尺度**: 未实现月/季节尺度归因
3. **不确定性**: 未集成Bootstrap重采样分析
4. **ISIMIP集成**: 未实现ACC/NCV分离（模块8计划）

### 8.2 扩展方向

- **多突变点**: 支持时间序列分段归因
- **空间归因**: 结合GRDC+ISIMIP网格数据
- **敏感性分析**: 参数n、突变年份的不确定性传播
- **可视化**: 堆叠柱状图、空间分布图

---

## 9. 常见问题

### Q1: 贡献率之和不等于100%？

**A**: 允许±10%误差，原因：
- 残差项（WADR）非直接计算
- 弹性系数基于全时段均值的近似
- 非线性效应积累

### Q2: 如何选择突变年份？

**A**: 三种方法：
1. **文献依据**：如1986（中国水保工程）
2. **统计检验**：Mann-Kendall趋势检测
3. **专家知识**：重大工程建设年份

### Q3: 负的贡献率如何理解？

**A**: 
- $C_{CCV} < 0$：气候变化缓解了径流减少
- 例：降水增加但径流仍减（LUCC/WADR主导）

### Q4: 参数n的物理意义？

**A**: 
- $n$小（~1.0）：沙漠、裸地，低蓄水能力
- $n$中（~2.0）：草地、农田
- $n$大（~3.5）：森林、高植被覆盖

---

## 10. 参考文献

1. **Wang et al. (2025)**. China's nationwide streamflow decline driven by landscape changes and human interventions. *Science Advances*, 11(32).

2. **Liu et al. (2019)**. Multimodel assessments of human and climate impacts on mean annual streamflow in China. *HESS*, 23(3): 1245-1261.

3. **Yang et al. (2008)**. New analytical derivation of the mean annual water-energy balance equation. *Water Resources Research*, 44, W03410.

4. **Roderick & Farquhar (2011)**. A simple framework for relating variations in runoff to variations in climatic conditions. *Water Resources Research*, 47, W00G07.

---

## 11. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-01-01 | 初始版本，完整6步流程，25个测试全通过 |

---

**文档最后更新**: 2025-01-01  
**维护者**: Research Software Engineer  
**GitHub**: [项目链接]

# 开发环境配置说明

## 环境问题诊断

### 之前base环境的警告

在base环境中安装依赖时出现以下警告：

```
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. 
This behaviour is the source of the following dependency conflicts.

tables 3.8.0 requires blosc2~=2.0.0, which is not installed.
tables 3.8.0 requires cython>=0.29.21, which is not installed.
python-lsp-black 1.2.1 requires black>=22.3.0, but you have black 0.0 which is incompatible.
```

### 影响分析

**结论: 这些警告不影响项目运行**

| 警告 | 影响程度 | 说明 |
|------|---------|------|
| tables缺少blosc2 | ❌ 无影响 | 项目未使用HDF5文件 |
| tables缺少cython | ❌ 无影响 | 项目未使用HDF5文件 |
| black版本冲突 | ⚠️ 轻微 | 仅影响代码格式化工具，不影响运行 |

**验证结果**:
- ✅ 模块1测试: 11/11 通过
- ✅ 模块2测试: 16/16 通过
- ✅ 所有核心依赖正常工作

---

## 独立虚拟环境: cat

为避免依赖冲突，已创建独立的`cat`环境。

### 环境信息

```yaml
名称: cat
类型: conda environment
Python版本: 3.11.14
创建时间: 2025-12-31
环境路径: D:\Anaconda3\envs\cat
```

### 安装的包（核心）

| 包名 | 版本 | 用途 |
|------|------|------|
| numpy | 2.4.0 | 数值计算 |
| pandas | 2.3.3 | 数据处理 |
| scipy | 1.16.3 | 科学计算 |
| xarray | 2025.12.0 | 多维数据 |
| rioxarray | 0.19.0 | 空间数据裁剪 |
| geopandas | 1.1.2 | 空间数据 |
| netCDF4 | 1.7.3 | NetCDF文件读取 |
| pyet | 1.4.0 | PET计算 |
| matplotlib | 3.10.8 | 可视化 |
| seaborn | 0.13.2 | 统计图表 |
| pytest | 9.0.2 | 测试框架 |
| pytest-cov | 7.0.0 | 覆盖率报告 |
| black | 25.12.0 | 代码格式化 |
| flake8 | 7.3.0 | 代码检查 |
| jupyter | 1.1.1 | Jupyter支持 |

完整包列表见 `requirements.txt`

### 测试验证

```bash
# 激活环境
conda activate cat

# 运行所有测试
pytest tests/ -v

# 结果
============================== 27 passed in 5.21s ===============================
✅ 模块1: 11/11 通过
✅ 模块2: 16/16 通过
```

---

## 使用指南

### 日常开发流程

1. **激活环境**
   ```bash
   conda activate cat
   ```

2. **验证环境**
   ```bash
   python --version
   # 应显示: Python 3.11.14
   
   which python
   # 应显示: D:\Anaconda3\envs\cat\python.exe
   ```

3. **运行测试**
   ```bash
   # 测试单个模块
   pytest tests/test_grdc_parser.py -v
   pytest tests/test_climate_processor.py -v
   
   # 测试全部
   pytest tests/ -v
   
   # 查看覆盖率
   pytest tests/ --cov=src --cov-report=html
   ```

4. **格式化代码**
   ```bash
   black src/
   black tests/
   ```

5. **代码质量检查**
   ```bash
   flake8 src/ --max-line-length=88
   ```

### VS Code配置

项目已自动配置`.vscode/settings.json`，包含：

- ✅ Python解释器: `D:\Anaconda3\envs\cat\python.exe`
- ✅ 测试框架: pytest
- ✅ 代码格式化: black (保存时自动格式化)
- ✅ 代码检查: flake8
- ✅ 行宽限制: 88字符

### 添加新依赖

1. **临时安装（测试）**
   ```bash
   conda activate cat
   pip install <package_name>
   ```

2. **永久添加**
   ```bash
   # 添加到requirements.txt
   echo "<package_name>>=<version>" >> requirements.txt
   
   # 更新environment.yml
   conda env export > environment.yml
   ```

3. **验证依赖**
   ```bash
   pip list
   ```

---

## 环境迁移

### 导出环境

```bash
# 方法1: conda格式（推荐）
conda activate cat
conda env export > environment.yml

# 方法2: pip格式
pip freeze > requirements.txt
```

### 在其他机器重建环境

```bash
# 使用conda
conda env create -f environment.yml
conda activate cat

# 或使用pip
conda create -n cat python=3.11 -y
conda activate cat
pip install -r requirements.txt
```

---

## 故障排查

### 问题1: 找不到conda命令

**解决方案**:
```bash
# Windows: 将Anaconda添加到PATH
# 或使用Anaconda Prompt
```

### 问题2: 环境激活失败

**解决方案**:
```bash
# 检查环境是否存在
conda env list

# 重新创建
conda env remove -n cat
conda create -n cat python=3.11 -y
conda activate cat
pip install -r requirements.txt
```

### 问题3: 导入错误

**解决方案**:
```bash
# 验证Python路径
python -c "import sys; print(sys.executable)"
# 应该是: D:\Anaconda3\envs\cat\python.exe

# 验证包安装
python -c "import xarray; print(xarray.__version__)"

# 重新安装缺失的包
pip install <missing_package>
```

### 问题4: VS Code未识别环境

**解决方案**:
1. 打开命令面板 (Ctrl+Shift+P)
2. 输入 "Python: Select Interpreter"
3. 选择 `D:\Anaconda3\envs\cat\python.exe`
4. 重启VS Code

---

## 环境对比

| 特性 | base环境 | cat环境 | 推荐 |
|------|---------|---------|------|
| Python版本 | 3.11.5 | 3.11.14 | cat ✅ |
| 依赖冲突 | 有警告 | 无冲突 | cat ✅ |
| 测试通过率 | 100% | 100% | 都可 |
| 环境隔离 | ❌ 全局 | ✅ 独立 | cat ✅ |
| 包版本 | 混合 | 统一 | cat ✅ |

**建议**: 后续开发统一使用`cat`环境，保证环境一致性。

---

## 环境清理（可选）

如果确认不再需要base环境的项目依赖，可以清理：

```bash
# 卸载base中的项目特定包（慎用！）
conda activate base
pip uninstall geopandas rioxarray -y

# 或直接使用cat环境，不清理base
# （推荐）保持base环境作为基础环境
```

---

**文档版本**: v1.0  
**创建日期**: 2025-12-31  
**环境状态**: ✅ 已验证可用
